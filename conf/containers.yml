---
- name:   ${conf.hostname_db}
  image:  "mdillon/postgis:9.6"
  ports:  [ "${conf.port_sql_host}:${conf.port_sql}" ]
  env:
    POSTGRES_USER:      ${conf.postgres_user}
    POSTGRES_PASSWORD:  ${conf.postgres_password}
    POSTGRES_DB:        ${conf.postgres_dbname}

- name:     ${conf.hostname_api}
  build:    ${conf.dir_api}
  git_repo: "github.com/${conf.repo_api}#${conf.version_api}"
  depend:   [ "${conf.hostname_db}" ]
  sync:
    - [ "sync/", "${conf.sync_api_dir}" ]
  env:
    # NOTE: libpq docu says it's 'posgresql://': https://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-CONNSTRING
    # TODO: echo special chars in the password maybe? low priority
    DATABASE_URL:       "postgres://${conf.postgres_user}:${conf.postgres_password}@${conf.hostname_db}:${conf.port_sql}/${conf.postgres_dbname}"
    # Schedule removal after IonosatMicro/promis-backend#9
    POSTGRES_USER:      ${conf.postgres_user}
    POSTGRES_PASSWORD:  ${conf.postgres_password}
    POSTGRES_DB:        ${conf.postgres_dbname}
    POSTGRES_HOST:      ${conf.hostname_db}
    POSTGRES_PORT:      ${conf.port_sql}
    # end of removal zone
    DJANGO_DEBUG:       ${conf.django_debug}
    DJANGO_KEY:         ${conf.django_key}
    SYNC_DIR:           ${conf.sync_api_dir}
    PYTHONUNBUFFERED:   "0"

- name:   ${conf.hostname_web}
  build:  ${conf.dir_web}
  git_repo: "github.com/${conf.repo_web}#${conf.version_web}"
  ports:  [ "${conf.port_api}", "${conf.port_web}" ]
  sync:
    - [ "nginx/", "/etc/nginx/conf.d/" ]
    - [ "ssl/", "${conf.ssl_prefix}"]
    - [ "sync/", "${conf.sync_web_dir}" ]
  depend: [ "${conf.hostname_api}" ]
  env:
    SERVERNAME_WEB:     ${conf.servername_web}
    SERVERNAME_API:     ${conf.servername_api}
    HOSTNAME_API:       ${conf.hostname_api}
    PORT_WEB:           ${conf.port_web}
    PORT_API:           ${conf.port_api}
    PORT_API_INTERNAL:  ${conf.port_api_internal}
    API_URL:            ${conf.api_url}
    PORT_KEY_WEB:       ${conf.port_key_web}
    PORT_KEY_API:       ${conf.port_key_api}
    SYNC_PATH:          ${conf.sync_web_path}
